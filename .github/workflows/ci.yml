name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

env:
  PYTHON_DEFAULT_VERSION: "3.13"

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install types-requests

      - name: Set up test environment
        run: |
          echo "MONGO_URI=mongodb://fake-server:27017" >> .env
          echo "DB_NAME=test_db" >> .env
          echo "QUOTES_API_URL=https://api.example.com/quotes" >> .env
          echo "COLLECTION_CRON=*/15" >> .env
          echo "API_TITLE=Test API" >> .env
          echo "API_VERSION=1.0.0" >> .env
          echo "ENABLE_CORRELATION_IDS=true" >> .env

      - name: Validate application can start
        run: |
          echo "Testing application import..."
          python -c "from app.main import app; print('âœ… Application imports successfully')"
          
      - name: Generate build info
        run: |
          echo "Build completed successfully!"
          echo "Python version: $(python --version)"
          echo "Dependencies: $(pip list | wc -l) packages"
          echo "Git commit: ${GITHUB_SHA}"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit[toml] safety types-requests

      - name: Set up test environment
        run: |
          echo "MONGO_URI=mongodb://fake-server:27017" >> .env
          echo "DB_NAME=test_db" >> .env
          echo "QUOTES_API_URL=https://api.example.com/quotes" >> .env
          echo "COLLECTION_CRON=*/15" >> .env
          echo "API_TITLE=Test API" >> .env
          echo "API_VERSION=1.0.0" >> .env
          echo "ENABLE_CORRELATION_IDS=true" >> .env

      - name: Run Bandit security linter
        run: |
          echo "Running Bandit security analysis..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -f txt || true
          echo "Bandit analysis completed. Check reports for any security issues."

      - name: Run Safety dependency check
        run: |
          echo "Checking for known security vulnerabilities..."
          safety check --json --output json > safety-report.json || true
          safety check || true
          echo "Safety check completed. Check reports for any vulnerabilities."

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Display Trivy results
        if: always() && hashFiles('trivy-results.sarif') != ''
        run: |
          echo "ğŸ” Trivy scan results:"
          cat trivy-results.sarif | head -20 || echo "Could not display SARIF file"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            trivy-results.sarif

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up test environment
        run: |
          echo "MONGO_URI=mongodb://fake-server:27017" >> .env
          echo "DB_NAME=test_db" >> .env
          echo "QUOTES_API_URL=https://api.example.com/quotes" >> .env
          echo "COLLECTION_CRON=*/15" >> .env
          echo "API_TITLE=Test API" >> .env
          echo "API_VERSION=1.0.0" >> .env
          echo "ENABLE_CORRELATION_IDS=true" >> .env

      - name: Validate application can start
        run: |
          echo "Testing application import..."
          python -c "from app.main import app; print('âœ… Application imports successfully')"
          
      - name: Generate build info
        run: |
          echo "Build completed successfully!"
          echo "Python version: $(python --version)"
          echo "Dependencies: $(pip list | wc -l) packages"
          echo "Git commit: ${GITHUB_SHA}"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [test, security, build]
    if: github.ref == 'refs/heads/dev'
    environment: staging
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging
        run: |
          echo "ğŸš€ Deploying to staging environment..."
          echo "This would deploy to your staging server"
          echo "Commit: ${GITHUB_SHA}"
          echo "Branch: ${GITHUB_REF_NAME}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, security, build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy with health checks
        run: |
          ssh ${{ secrets.SERVER_USER }}@${ secrets.SERVER_HOST }} << 'EOF'
            set -e  # Exit on any error
            set -u  # Treat unset variables as error
            
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to application directory
            cd ${{ secrets.APP_LOCATION }}
            
            # Create backup of current version
            BACKUP_DIR="../backup-$(date +%Y%m%d-%H%M%S)"
            echo "ğŸ“¦ Creating backup in $BACKUP_DIR"
            cp -r . "$BACKUP_DIR" || true
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # Activate virtual environment and install dependencies
            echo "ğŸ”§ Installing dependencies..."
            source venv/bin/activate
            pip install -r requirements.txt
            
            # Run any database migrations if needed
            # echo "ğŸ—„ï¸ Running database migrations..."
            # python -m app.database migrate || true
            
            # Restart the service
            echo "ğŸ”„ Restarting service..."
            sudo systemctl restart pix-historial
            
            # Wait for service to start
            echo "â³ Waiting for service to start..."
            sleep 10
            
            # Health check
            echo "ğŸ¥ Running health check..."
            HEALTH_URL="http://localhost:8001/health"
            MAX_ATTEMPTS=30
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              if curl -f -s "$HEALTH_URL" > /dev/null; then
                echo "âœ… Health check passed!"
                echo "ğŸ‰ Deployment successful!"
                exit 0
              fi
              
              echo "â³ Health check attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in 2 seconds..."
              sleep 2
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo "âŒ Health check failed after $MAX_ATTEMPTS attempts!"
            echo "ğŸ”„ Rolling back to backup..."
            
            # Rollback
            sudo systemctl stop pix-historial
            rm -rf ./*
            cp -r "$BACKUP_DIR"/* ./
            sudo systemctl start pix-historial
            
            echo "ğŸ”„ Rollback completed"
            exit 1
          EOF

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 15
          
          # Check if the application is responding
          if curl -f -s "http://${{ secrets.SERVER_HOST }}:8001/health" > /dev/null; then
            echo "âœ… Production deployment verified!"
          else
            echo "âŒ Production deployment verification failed!"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ Production deployment completed successfully!"
            echo "ğŸ“Š Deployment metrics:"
            echo "  - Commit: ${GITHUB_SHA}"
            echo "  - Branch: ${GITHUB_REF_NAME}"
            echo "  - Timestamp: $(date -u)"
          else
            echo "âŒ Production deployment failed!"
            echo "ğŸ”§ Please check the logs and investigate the issue."
          fi
