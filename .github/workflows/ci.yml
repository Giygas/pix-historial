name: CI/CD Pipeline

on:
  push:
    branches: [main, dev]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up test environment
        run: |
          echo "MONGO_URI=mongodb://fake-server:27017" > .env
          echo "DB_NAME=test_db" >> .env
          echo "QUOTES_API_URL=https://api.example.com/quotes" >> .env
          echo "COLLECTION_CRON=*/15" >> .env
          echo "API_TITLE=Test API" >> .env
          echo "API_VERSION=1.0.0" >> .env
          echo "ENABLE_CORRELATION_IDS=true" >> .env

      - name: Test application import
        run: |
          python -c "from app.main import app; print('✅ Application imports successfully')"

      - name: Run tests
        run: |
          python -m pytest tests/ -x --tb=short --cov=app --cov-report=term-missing

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Deploy with health check and rollback
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_ADRESS }} << 'EOF'
            set -e
            
            # Navigate to app directory
            cd ${{ secrets.APP_LOCATION }}
            
            # Create backup
            BACKUP_DIR="../backup-$(date +%Y%m%d-%H%M%S)"
            cp -r . "$BACKUP_DIR"
            
            # Deploy
            git pull origin main
            source venv/bin/activate
            pip install -r requirements.txt
            sudo systemctl restart pix-historial
            
            # Wait for service to start
            sleep 15
            
            # Health check
            HEALTH_URL="https://pix-historial.giygas.dev/health"
            MAX_ATTEMPTS=12
            ATTEMPT=1
            
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              if curl -f -s "$HEALTH_URL" | grep -q '"status":"healthy"'; then
                echo "✅ Health check passed!"
                exit 0
              fi
              
              echo "⏳ Health check attempt $ATTEMPT/$MAX_ATTEMPTS failed, retrying in 10 seconds..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            done
            
            echo "❌ Health check failed, rolling back..."
            sudo systemctl stop pix-historial
            rm -rf ./*
            cp -r "$BACKUP_DIR"/* ./
            sudo systemctl start pix-historial
            exit 1
          EOF
